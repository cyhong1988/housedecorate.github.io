<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è£æ½¢é ç®—ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --primary-color: #2c3e50;
            --accent-color: #d4af37;
            --text-main: #333;
            --text-sub: #7f8c8d;
            --danger: #e74c3c;
            --success: #27ae60;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 950px; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-weight: 300; letter-spacing: 2px; color: var(--primary-color); margin-bottom: 10px; font-size: 1.6rem; }

        /* å„€è¡¨æ¿æ¨£å¼ */
        .summary-dashboard {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }
        .summary-item .label { font-size: 0.75rem; opacity: 0.8; margin-bottom: 5px; }
        .summary-item .amount { font-size: 1.2rem; font-weight: 600; color: var(--accent-color); word-break: break-all; }
        .budget-input {
            background: rgba(255,255,255,0.1); color: var(--accent-color); font-size: 1.2rem;
            font-weight: 600; width: 100%; padding: 5px 0; border: none; border-bottom: 1px solid var(--accent-color); outline: none;
        }
        .remaining-negative { color: var(--danger) !important; }

        /* å¡ç‰‡èˆ‡è¼¸å…¥æ¡† */
        .category-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 15px; margin-bottom: 25px; box-shadow: var(--shadow); }
        .category-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f1f1; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .category-title { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
        .subtotal { font-size: 0.9rem; color: var(--text-sub); }

        .input-group { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; }
        input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; transition: 0.3s; font-size: 14px; }
        input:focus { border-color: var(--accent-color); }
        .name-input { flex: 2; min-width: 0; }
        .url-input { flex: 2; min-width: 0; }
        .price-input { flex: 1; min-width: 0; }

        button { cursor: pointer; border: none; border-radius: 6px; transition: 0.3s; }
        .btn-add { background: var(--primary-color); color: white; padding: 10px 15px; white-space: nowrap; flex: 0.5; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-wrapper { width: 100%; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 12px 4px; border-bottom: 1px solid #eee; font-size: 0.85rem; word-break: break-word; }
        .col-drag { width: 30px; }
        .col-name { width: auto; }
        .col-url { width: 40px; text-align: center; }
        .col-price { width: 85px; text-align: right; }
        .col-action { width: 75px; text-align: right; }
        .drag-handle { cursor: grab; color: #ccc; font-size: 1rem; }
        .btn-edit { color: var(--text-sub); margin-right: 5px; font-size: 1.1rem; }
        .btn-delete { color: #ccc; font-size: 1.1rem; }
        .link-icon { text-decoration: none; color: var(--accent-color); font-size: 1.1rem; }

        /* --- å½ˆè·³è¦–çª— Modal æ¨£å¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; /* é è¨­éš±è— */
            justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; padding: 25px; border-radius: var(--border-radius);
            width: 90%; max-width: 400px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-header { font-weight: 600; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 5px; }
        .modal-field { display: flex; flex-direction: column; gap: 5px; }
        .modal-field label { font-size: 0.8rem; color: var(--text-sub); }
        .modal-field input { width: 100%; border: 1px solid #ddd; padding: 12px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-modal-save { background: var(--primary-color); color: white; flex: 2; padding: 12px; font-weight: 600; }
        .btn-modal-cancel { background: #eee; color: var(--text-main); flex: 1; padding: 12px; }

        .sync-status { font-size: 0.75rem; text-align: center; margin-top: -20px; margin-bottom: 15px; color: var(--text-sub); }

        @media (max-width: 600px) {
            .summary-dashboard { grid-template-columns: 1fr 1fr; padding: 15px; }
            .input-group { flex-direction: column; gap: 8px; }
            .name-input, .url-input, .price-input, .btn-add { width: 100%; flex: none; }
            td { font-size: 0.8rem; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">ç·¨è¼¯é …ç›®</div>
        <input type="hidden" id="edit-id">
        <input type="hidden" id="edit-category">
        
        <div class="modal-field">
            <label>é …ç›®åç¨±</label>
            <input type="text" id="modal-name">
        </div>
        <div class="modal-field">
            <label>åƒè€ƒç¶²å€</label>
            <input type="text" id="modal-url" placeholder="http://...">
        </div>
        <div class="modal-field">
            <label>é ç®—é‡‘é¡</label>
            <input type="number" id="modal-price">
        </div>
        
        <div class="modal-actions">
            <button class="btn-modal-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-modal-save" onclick="saveEdit()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <h1>åº­æ—ç¾¤é’ è£æ½¢é ç®—æ›¸</h1>
        <p style="color: var(--text-sub); font-size: 0.9rem;">ç´°å¿ƒè¦åŠƒï¼Œæ‰“é€ ç†æƒ³çš„ç”Ÿæ´»ç©ºé–“</p>
    </header>

    <div class="sync-status" id="sync-status">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</div>

    <div class="summary-dashboard">
        <div class="summary-item">
            <div class="label">ğŸ¯ é ç®—ç›®æ¨™</div>
            <input type="number" id="budget-goal" class="budget-input" placeholder="0" oninput="updateTotalsOnly()">
        </div>
        <div class="summary-item">
            <div class="label">ğŸ’° ç´¯è¨ˆæ”¯å‡º</div>
            <div class="amount" id="grand-total">$ 0</div>
        </div>
        <div class="summary-item">
            <div class="label">âš–ï¸ å‰©é¤˜é ç®—</div>
            <div class="amount" id="remaining-budget">$ 0</div>
        </div>
        <div class="summary-item">
            <div class="label">ğŸ“Š å·¥ç¨‹ä½”æ¯”</div>
            <div class="amount" id="percent-eng">0%</div>
        </div>
    </div>

    <section class="category-card" data-category="engineering">
        <div class="category-header">
            <div class="category-title"><span>ğŸ—ï¸</span> è£ä¿®å·¥ç¨‹é ç®—</div>
            <div class="subtotal">å°è¨ˆ: <span id="subtotal-engineering">$ 0</span></div>
        </div>
        <div class="input-group">
            <input type="text" class="name-input" placeholder="é …ç›®åç¨±...">
            <input type="text" class="url-input" placeholder="ç¶²å€...">
            <input type="number" class="price-input" placeholder="é‡‘é¡">
            <button class="btn-add" onclick="addItem('engineering')">æ–°å¢</button>
        </div>
        <div class="table-wrapper">
            <table id="table-engineering">
                <thead><tr><th class="col-drag"></th><th class="col-name">åç¨±</th><th class="col-url">ç¶²å€</th><th class="col-price">é‡‘é¡</th><th class="col-action">æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section class="category-card" data-category="appliances">
        <div class="category-header">
            <div class="category-title"><span>ğŸ“º</span> å®¶é›»è¨­å‚™é ç®—</div>
            <div class="subtotal">å°è¨ˆ: <span id="subtotal-appliances">$ 0</span></div>
        </div>
        <div class="input-group">
            <input type="text" class="name-input" placeholder="é …ç›®åç¨±...">
            <input type="text" class="url-input" placeholder="ç¶²å€...">
            <input type="number" class="price-input" placeholder="é‡‘é¡">
            <button class="btn-add" onclick="addItem('appliances')">æ–°å¢</button>
        </div>
        <div class="table-wrapper">
            <table id="table-appliances">
                <thead><tr><th class="col-drag"></th><th class="col-name">åç¨±</th><th class="col-url">ç¶²å€</th><th class="col-price">é‡‘é¡</th><th class="col-action">æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section class="category-card" data-category="furniture">
        <div class="category-header">
            <div class="category-title"><span>ğŸ›‹ï¸</span> å‚¢ä¿±è»Ÿè£é ç®—</div>
            <div class="subtotal">å°è¨ˆ: <span id="subtotal-furniture">$ 0</span></div>
        </div>
        <div class="input-group">
            <input type="text" class="name-input" placeholder="é …ç›®åç¨±...">
            <input type="text" class="url-input" placeholder="ç¶²å€...">
            <input type="number" class="price-input" placeholder="é‡‘é¡">
            <button class="btn-add" onclick="addItem('furniture')">æ–°å¢</button>
        </div>
        <div class="table-wrapper">
            <table id="table-furniture">
                <thead><tr><th class="col-drag"></th><th class="col-name">åç¨±</th><th class="col-url">ç¶²å€</th><th class="col-price">é‡‘é¡</th><th class="col-action">æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0MvelMerRnzM8v7yN7RA-OcA4e0pSl9MO20FOSDJIbGml2yCiAz1qxSpvnVfDucbb/exec';
    let data = { engineering: [], appliances: [], furniture: [] };

    // åˆå§‹åŒ–èˆ‡è¼‰å…¥
    async function initData() {
        const savedBudget = localStorage.getItem('decoration_budget_goal');
        if (savedBudget) document.getElementById('budget-goal').value = savedBudget;
        const statusEl = document.getElementById('sync-status');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const cloudData = await response.json();
            data = { engineering: [], appliances: [], furniture: [] };
            cloudData.forEach(item => {
                if (data[item.category]) {
                    data[item.category].push({ id: item.id, name: item.name, url: item.url || '', price: parseFloat(item.price) });
                }
            });
            statusEl.innerText = 'é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼šè³‡æ–™è¼‰å…¥æˆåŠŸ';
            statusEl.style.color = 'var(--success)';
        } catch (e) {
            statusEl.innerText = 'é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼šè¼‰å…¥å¤±æ•—';
            statusEl.style.color = 'var(--danger)';
        }
        render();
        initSortable();
    }

    // æ‹–æ›³æ’åº
    function initSortable() {
        ['engineering', 'appliances', 'furniture'].forEach(category => {
            const el = document.querySelector(`#table-${category} tbody`);
            Sortable.create(el, {
                animation: 150, handle: '.drag-handle',
                onEnd: function (evt) {
                    const categoryData = data[category];
                    const item = categoryData.splice(evt.oldIndex, 1)[0];
                    categoryData.splice(evt.newIndex, 0, item);
                    updateTotalsOnly();
                    syncToCloud('REORDER', category, { idOrder: categoryData.map(i => i.id) });
                }
            });
        });
    }

    // åŒæ­¥è‡³ Google Sheets
    async function syncToCloud(action, category, item) {
        const statusEl = document.getElementById('sync-status');
        statusEl.innerText = 'é›²ç«¯åŒæ­¥ä¸­...';
        statusEl.style.color = 'var(--accent-color)';
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action, category, ...item })
            });
            statusEl.innerText = 'åŒæ­¥å®Œæˆï¼š' + new Date().toLocaleTimeString();
            statusEl.style.color = 'var(--success)';
        } catch (e) {
            statusEl.innerText = 'åŒæ­¥å¤±æ•—';
            statusEl.style.color = 'var(--danger)';
        }
    }

    // æ–°å¢é …ç›®
    function addItem(category) {
        const card = document.querySelector(`section[data-category="${category}"]`);
        const nameInp = card.querySelector('.name-input');
        const urlInp = card.querySelector('.url-input');
        const priceInp = card.querySelector('.price-input');
        if (!nameInp.value || !priceInp.value) return;

        const newItem = { id: Date.now(), name: nameInp.value, url: urlInp.value, price: parseFloat(priceInp.value) };
        data[category].push(newItem);
        syncToCloud('ADD', category, newItem);
        nameInp.value = ''; urlInp.value = ''; priceInp.value = '';
        render();
    }

    // --- å½ˆçª—ç·¨è¼¯é‚è¼¯ ---
    function openModal(category, id) {
        const item = data[category].find(i => i.id === id);
        if (!item) return;
        
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-category').value = category;
        document.getElementById('modal-name').value = item.name;
        document.getElementById('modal-url').value = item.url || '';
        document.getElementById('modal-price').value = item.price;
        
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function saveEdit() {
        const id = parseInt(document.getElementById('edit-id').value);
        const category = document.getElementById('edit-category').value;
        const newName = document.getElementById('modal-name').value.trim();
        let newUrl = document.getElementById('modal-url').value.trim();
        const newPrice = parseFloat(document.getElementById('modal-price').value) || 0;

        // å®‰å…¨æª¢æ¸¬ï¼šé˜²æ­¢å¡«å…¥æ•´å€‹ HTML
        if (newUrl.includes('<html') || newUrl.length > 500) {
            alert('åµæ¸¬åˆ°ç¶²å€æ ¼å¼éŒ¯èª¤ï¼Œå·²è‡ªå‹•æ¸…é™¤ã€‚');
            newUrl = '';
        }

        const item = data[category].find(i => i.id === id);
        if (item) {
            item.name = newName;
            item.url = newUrl;
            item.price = newPrice;
            syncToCloud('UPDATE', category, item);
        }
        
        closeModal();
        render();
    }

    function deleteItem(category, id) {
        if(!confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
        data[category] = data[category].filter(i => i.id !== id);
        syncToCloud('DELETE', category, { id });
        render();
    }

    // è¨ˆç®—èˆ‡æ¸²æŸ“
    function formatCurrency(num) { return '$' + Math.round(num).toLocaleString(); }

    function updateTotalsOnly() {
        let grandTotal = 0;
        let subtotalMap = { engineering: 0, appliances: 0, furniture: 0 };
        for (let category in data) {
            data[category].forEach(item => subtotalMap[category] += item.price);
            document.getElementById(`subtotal-${category}`).innerText = formatCurrency(subtotalMap[category]);
            grandTotal += subtotalMap[category];
        }
        document.getElementById('grand-total').innerText = formatCurrency(grandTotal);
        const budgetGoal = parseFloat(document.getElementById('budget-goal').value) || 0;
        localStorage.setItem('decoration_budget_goal', budgetGoal);
        const remaining = budgetGoal - grandTotal;
        const remainingEl = document.getElementById('remaining-budget');
        remainingEl.innerText = formatCurrency(remaining);
        remainingEl.className = 'amount' + (remaining < 0 ? ' remaining-negative' : '');
        const engPercent = grandTotal > 0 ? Math.round((subtotalMap.engineering / grandTotal) * 100) : 0;
        document.getElementById('percent-eng').innerText = engPercent + '%';
    }

    function render() {
        for (let category in data) {
            const tbody = document.querySelector(`#table-${category} tbody`);
            tbody.innerHTML = data[category].length ? '' : '<tr><td colspan="5" style="text-align:center; padding: 20px; color:#ccc;">å°šç„¡é …ç›®</td></tr>';
            data[category].forEach(item => {
                const tr = document.createElement('tr');
                const urlLink = item.url ? `<a href="${item.url.startsWith('http') ? item.url : 'https://' + item.url}" target="_blank" class="link-icon">ğŸ”—</a>` : '';
                tr.innerHTML = `
                    <td class="col-drag drag-handle">â˜°</td>
                    <td class="col-name">${item.name}</td>
                    <td class="col-url">${urlLink}</td>
                    <td class="col-price">${formatCurrency(item.price)}</td>
                    <td class="col-action">
                        <button class="btn-edit" onclick="openModal('${category}', ${item.id})">âœ</button>
                        <button class="btn-delete" onclick="deleteItem('${category}', ${item.id})">Ã—</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
        updateTotalsOnly();
    }

    initData();
</script>
</body>
</html>
