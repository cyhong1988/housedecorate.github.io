<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è£æ½¢é ç®—ç®¡ç†å¤§å¸« - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --primary-color: #2c3e50;
            --accent-color: #d4af37;
            --text-main: #333;
            --text-sub: #7f8c8d;
            --danger: #e74c3c;
            --success: #27ae60;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 900px; }
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-weight: 300; letter-spacing: 2px; color: var(--primary-color); margin-bottom: 10px; }

        .summary-dashboard {
            background: var(--primary-color);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .summary-item .label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; }
        .summary-item .amount { font-size: 1.5rem; font-weight: 600; color: var(--accent-color); }

        .category-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .category-title { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; transition: 0.3s; width: 100%;}
        input:focus { border-color: var(--accent-color); }
        input.name-input, .edit-name { flex: 2; }
        input.price-input, .edit-price { flex: 1; }

        button { cursor: pointer; border: none; border-radius: 6px; transition: 0.3s; background: none; }
        .btn-add { background: var(--primary-color); color: white; padding: 10px 20px; white-space: nowrap; }
        .btn-add:hover { background: #3e5871; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--text-sub); font-size: 0.85rem; padding: 10px; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; }

        /* æ‹–æ›³æŠŠæ‰‹æ¨£å¼ */
        .drag-handle {
            cursor: grab;
            color: #ccc;
            padding-right: 10px;
            font-size: 1.2rem;
            user-select: none;
            width: 20px;
        }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.3; background: #f0f0f0 !important; }

        .col-action { text-align: right; min-width: 120px; }
        .btn-edit { color: var(--text-sub); margin-right: 10px; font-size: 0.9rem; }
        .btn-delete { color: #ccc; font-size: 1.2rem; }
        .btn-save { color: var(--success); font-weight: bold; margin-right: 10px; }

        .sync-status { font-size: 0.8rem; text-align: center; margin-top: -30px; margin-bottom: 20px; color: var(--text-sub); transition: 0.5s;}
        .empty-hint { text-align: center; color: #ccc; padding: 20px; font-style: italic; }
        
        @media (max-width: 600px) { .input-group { flex-direction: column; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>æ–°å®¶è£æ½¢é ç®—æ›¸</h1>
        <p style="color: var(--text-sub)">ç´°å¿ƒè¦åŠƒï¼Œæ‰“é€ ç†æƒ³çš„ç”Ÿæ´»ç©ºé–“</p>
    </header>

    <div class="sync-status" id="sync-status">é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼šæ­£åœ¨åˆå§‹åŒ–...</div>

    <div class="summary-dashboard">
        <div class="summary-item">
            <div class="label">ç¸½é ç®—æ”¯å‡º</div>
            <div class="amount" id="grand-total">$ 0</div>
        </div>
        <div class="summary-item">
            <div class="label">å·¥ç¨‹ä½”æ¯”</div>
            <div class="amount" id="percent-eng">0%</div>
        </div>
        <div class="summary-item">
            <div class="label">å®¶é›»/å‚¢ä¿±ä½”æ¯”</div>
            <div class="amount" id="percent-other">0%</div>
        </div>
    </div>

    <section class="category-card" data-category="engineering">
        <div class="category-header"><div class="category-title"><span>ğŸ—ï¸</span> è£ä¿®å·¥ç¨‹é ç®—</div><div class="subtotal">å°è¨ˆ: <span id="subtotal-engineering">$ 0</span></div></div>
        <div class="input-group">
            <input type="text" class="name-input" placeholder="é …ç›®åç¨±...">
            <input type="number" class="price-input" placeholder="é‡‘é¡">
            <button class="btn-add" onclick="addItem('engineering')">æ–°å¢é …ç›®</button>
        </div>
        <table id="table-engineering"><thead><tr><th style="width: 30px;"></th><th>åç¨±</th><th>é‡‘é¡</th><th class="col-action">æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </section>

    <section class="category-card" data-category="appliances">
        <div class="category-header"><div class="category-title"><span>ğŸ“º</span> å®¶é›»è¨­å‚™é ç®—</div><div class="subtotal">å°è¨ˆ: <span id="subtotal-appliances">$ 0</span></div></div>
        <div class="input-group">
            <input type="text" class="name-input" placeholder="é …ç›®åç¨±...">
            <input type="number" class="price-input" placeholder="é‡‘é¡">
            <button class="btn-add" onclick="addItem('appliances')">æ–°å¢é …ç›®</button>
        </div>
        <table id="table-appliances"><thead><tr><th style="width: 30px;"></th><th>åç¨±</th><th>é‡‘é¡</th><th class="col-action">æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </section>

    <section class="category-card" data-category="furniture">
        <div class="category-header"><div class="category-title"><span>ğŸ›‹ï¸</span> å‚¢ä¿±è»Ÿè£é ç®—</div><div class="subtotal">å°è¨ˆ: <span id="subtotal-furniture">$ 0</span></div></div>
        <div class="input-group">
            <input type="text" class="name-input" placeholder="é …ç›®åç¨±...">
            <input type="number" class="price-input" placeholder="é‡‘é¡">
            <button class="btn-add" onclick="addItem('furniture')">æ–°å¢é …ç›®</button>
        </div>
        <table id="table-furniture"><thead><tr><th style="width: 30px;"></th><th>åç¨±</th><th>é‡‘é¡</th><th class="col-action">æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </section>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0MvelMerRnzM8v7yN7RA-OcA4e0pSl9MO20FOSDJIbGml2yCiAz1qxSpvnVfDucbb/exec';

    let data = { engineering: [], appliances: [], furniture: [] };

    async function initData() {
        const statusEl = document.getElementById('sync-status');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const cloudData = await response.json();
            
            data = { engineering: [], appliances: [], furniture: [] };
            cloudData.forEach(item => {
                if (data[item.category]) {
                    data[item.category].push({ id: item.id, name: item.name, price: parseFloat(item.price) });
                }
            });
            statusEl.innerText = 'é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼šè³‡æ–™è¼‰å…¥æˆåŠŸ';
            statusEl.style.color = 'var(--success)';
        } catch (e) {
            statusEl.innerText = 'é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼šè¼‰å…¥å¤±æ•—';
            statusEl.style.color = 'var(--danger)';
        }
        render();
        initSortable();
    }

    function initSortable() {
        ['engineering', 'appliances', 'furniture'].forEach(category => {
            const el = document.querySelector(`#table-${category} tbody`);
            Sortable.create(el, {
                animation: 150,
                handle: '.drag-handle', // é™åˆ¶åªæœ‰é»æ“Šæ­¤ class æ‰èƒ½æ‹–æ›³
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    if (evt.oldIndex === evt.newIndex) return;

                    const categoryData = data[category];
                    const item = categoryData.splice(evt.oldIndex, 1)[0];
                    categoryData.splice(evt.newIndex, 0, item);
                    
                    updateTotalsOnly();
                    const idOrder = categoryData.map(i => i.id);
                    syncToCloud('REORDER', category, { idOrder: idOrder });
                },
            });
        });
    }

    async function syncToCloud(action, category, item) {
        const statusEl = document.getElementById('sync-status');
        statusEl.innerText = 'é›²ç«¯åŒæ­¥ä¸­...';
        statusEl.style.color = 'var(--accent-color)';

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action, category, ...item })
            });
            statusEl.innerText = 'é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼šå·²åŒæ­¥æ–¼ ' + new Date().toLocaleTimeString();
            statusEl.style.color = 'var(--success)';
        } catch (e) {
            statusEl.innerText = 'åŒæ­¥å¤±æ•—';
            statusEl.style.color = 'var(--danger)';
        }
    }

    function addItem(category) {
        const card = document.querySelector(`section[data-category="${category}"]`);
        const nameInp = card.querySelector('.name-input');
        const priceInp = card.querySelector('.price-input');
        if (!nameInp.value || !priceInp.value) return;

        const newItem = { id: Date.now(), name: nameInp.value, price: parseFloat(priceInp.value) };
        data[category].push(newItem);
        syncToCloud('ADD', category, newItem);
        nameInp.value = ''; priceInp.value = '';
        render();
    }

    function deleteItem(category, id) {
        if(!confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;
        data[category] = data[category].filter(i => i.id !== id);
        syncToCloud('DELETE', category, { id });
        render();
    }

    function enterEditMode(category, id) {
        const item = data[category].find(i => i.id === id);
        const row = document.getElementById(`row-${id}`);
        row.innerHTML = `
            <td class="drag-handle">â˜°</td>
            <td><input type="text" class="edit-name" value="${item.name}"></td>
            <td><input type="number" class="edit-price" value="${item.price}"></td>
            <td class="col-action">
                <button class="btn-save" onclick="saveEdit('${category}', ${id})">å„²å­˜</button>
                <button class="btn-delete" onclick="render()">âœ˜</button>
            </td>
        `;
    }

    function saveEdit(category, id) {
        const row = document.getElementById(`row-${id}`);
        const newName = row.querySelector('.edit-name').value;
        const newPrice = parseFloat(row.querySelector('.edit-price').value);
        const item = data[category].find(i => i.id === id);
        item.name = newName; item.price = newPrice;
        syncToCloud('UPDATE', category, item);
        render();
    }

    function formatCurrency(num) { return '$ ' + Math.round(num).toLocaleString(); }

    function updateTotalsOnly() {
        let grandTotal = 0;
        let subtotalMap = { engineering: 0, appliances: 0, furniture: 0 };
        for (let category in data) {
            data[category].forEach(item => subtotalMap[category] += item.price);
            document.getElementById(`subtotal-${category}`).innerText = formatCurrency(subtotalMap[category]);
            grandTotal += subtotalMap[category];
        }
        document.getElementById('grand-total').innerText = formatCurrency(grandTotal);
        const engPercent = grandTotal > 0 ? Math.round((subtotalMap.engineering / grandTotal) * 100) : 0;
        const otherPercent = grandTotal > 0 ? Math.round(((subtotalMap.appliances + subtotalMap.furniture) / grandTotal) * 100) : 0;
        document.getElementById('percent-eng').innerText = engPercent + '%';
        document.getElementById('percent-other').innerText = otherPercent + '%';
    }

    function render() {
        for (let category in data) {
            const tbody = document.querySelector(`#table-${category} tbody`);
            tbody.innerHTML = data[category].length ? '' : '<tr><td colspan="4" class="empty-hint">å°šç„¡é …ç›®</td></tr>';
            data[category].forEach(item => {
                const tr = document.createElement('tr');
                tr.id = `row-${item.id}`;
                tr.setAttribute('data-id', item.id);
                tr.innerHTML = `
                    <td class="drag-handle">â˜°</td>
                    <td>${item.name}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td class="col-action">
                        <button class="btn-edit" onclick="enterEditMode('${category}', ${item.id})">âœ</button>
                        <button class="btn-delete" onclick="deleteItem('${category}', ${item.id})">Ã—</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
        updateTotalsOnly();
    }

    initData();
</script>
</body>
</html>
